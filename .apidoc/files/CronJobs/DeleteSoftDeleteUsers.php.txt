<?php
/**
 * @license http://opensource.org/licenses/MIT MIT
 */


namespace Modules\RdbAdmin\CronJobs;


/**
 * Delete the users that was mark as soft delete.
 * 
 * @since 0.1
 */
class DeleteSoftDeleteUsers extends BaseCronJobs
{


    /**
     * {@inheritDoc}
     */
    public function execute(): bool
    {
        // crontab format is 'minute' 'hour' 'day of month' 'month' 'day of week'
        // 0-15 for minute unit is start at 0 minute but can delay for 15 minutes.
        $CronExpression = new \Cron\CronExpression('0-15 0 * * *', new \Cron\FieldFactory());

        if ($CronExpression->isDue() && !$this->Cron->hasRun()) {
            $keepSoftDeleteForDays = 30;// keep for xx days.
            $sql = 'SELECT `user_id`, `user_deleted`, `user_deleted_since_gmt` 
                FROM `' . $this->Db->tableName('users') . '` 
                WHERE `user_deleted` = 1 AND `user_deleted_since_gmt` < :user_deleted_since_gmt';
            $Sth = $this->Db->PDO()->prepare($sql);
            unset($sql);

            $DateTimeUtc = new \DateTime('now', new \DateTimeZone('UTC'));
            $DateTimeUtc->sub(new \DateInterval('P' . $keepSoftDeleteForDays . 'D'));

            $Sth->bindValue(':user_deleted_since_gmt', $DateTimeUtc->format('Y-m-d H:i:s'));
            $Sth->execute();

            $result = $Sth->fetchAll();
            if (is_array($result)) {
                $UsersDb = new \Modules\RdbAdmin\Models\UsersDb($this->Container);
                foreach ($result as $row) {
                    $UsersDb->delete((int) $row->user_id);
                }// endforeach;
                unset($row, $UsersDb);
            }
            unset($result);

            $Sth->closeCursor();
            unset($DateTimeUtc, $keepSoftDeleteForDays, $Sth);

            // write cache that this job had already run.
            $cacheTTL = $this->getSecondsBeforeNext();
            $this->Cron->cacheHadRun($cacheTTL);
            unset($cacheTTL);

            unset($CronExpression);
            return true;
        }// endif isDue()

        unset($CronExpression);
        return false;
    }// execute


}

